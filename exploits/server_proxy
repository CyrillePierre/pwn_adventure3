#!/usr/bin/env python3
import socket
import select
import threading

def handle_client(s_client, port):
    s_game = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s_game.connect(('192.168.99.35', port))

    def listen_client():
        while 1:
            data = s_client.recv(8192)
            if not data: break
            print('[client] raw: ', data)
            s_game.sendall(data)

    def listen_server():
        while 1:
            data = s_game.recv(8192)
            if not data: break
            print('[server] raw: ', data)
            s_client.sendall(data)

    th_client = threading.Thread(target=listen_client)
    th_server = threading.Thread(target=listen_server)
    th_client.daemon = True
    th_server.daemon = True
    th_client.start()
    th_server.start()


socks = []
for i in range(5):
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    s.bind(('0.0.0.0', 3000 + i))
    s.listen(1)
    socks.append(s)

while 1:
    rl, wl, el = select.select(socks, [], [])
    for s in rl:
        s_client, addr = s.accept()
        print('[accept] New connection: ', addr)
        handle_client(s_client, s.getsockname()[1])

for s in socks: s.close()
